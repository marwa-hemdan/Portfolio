<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Firestore Data Viewer</title>
	<link rel="stylesheet" href="assets/css/main.css" />
	<style>
		/* Basic styling */
		body {
			font-family: Arial, sans-serif;

			margin: 0 auto;
			padding: 20px;
			line-height: 1.6;
		}

		.loading-indicator {
			text-align: center;
			margin: 30px 0;
		}

		.spinner {
			border: 5px solid #f3f3f3;
			border-top: 5px solid #3498db;
			border-radius: 50%;
			width: 50px;
			height: 50px;
			animation: spin 1s linear infinite;
			margin: 0 auto 15px;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		.error-message {
			color: red;
			padding: 15px;
			border: 1px solid #ffcccc;
			background-color: #ffeeee;
			border-radius: 4px;
			margin: 20px 0;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 20px;
		}

		th,
		td {
			border: 1px solid #ddd;
			padding: 12px;
			text-align: left;
		}

		th {
			background-color: #f2f2f2;
		}

		.hidden {
			display: none;
		}
	</style>
</head>

<body>

	<h1>Contact Form Submissions</h1>
	</article>
	<!-- Loading Indicator (initially visible) -->
	<div id="loadingIndicator" class="loading-indicator">
		<div class="spinner"></div>
		<p>Loading data from database...</p>
	</div>

	<!-- Error Container (initially hidden) -->
	<div id="errorContainer" class="error-message hidden"></div>

	<!-- Data Table Container (initially hidden) -->
	<div id="tableContainer" class="hidden">
		<table>
			<thead>
				<tr>
					<th>Name</th>
					<th>Email</th>
					<th>Message</th>
					<th>Submission Date</th>
				</tr>
			</thead>
			<tbody id="tableBody"></tbody>
		</table>
	</div>

	<!-- Firebase SDKs - Placed at BOTTOM of body -->
	<script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore-compat.js"></script>

	<!-- Main Application Script -->
	<script>
		
		// Wait until the ENTIRE page is loaded
		window.addEventListener('DOMContentLoaded', function () {
			// 1. Get all required DOM elements
			const domElements = {
				loading: document.getElementById('loadingIndicator'),
				error: document.getElementById('errorContainer'),
				tableContainer: document.getElementById('tableContainer'),
				tableBody: document.getElementById('tableBody')
			};

			// 2. Verify all elements exist
			let allElementsExist = true;
			for (const [key, element] of Object.entries(domElements)) {
				if (!element) {
					console.error(`Missing element: ${key}`);
					allElementsExist = false;
				}
			}

			if (!allElementsExist) {
				// Create a basic error display if the proper one is missing
				const errorDisplay = domElements.error || document.body;
				errorDisplay.innerHTML = `
                    <div class="error-message">
                        <strong>Critical Error:</strong> Required page elements missing.
                        Please refresh the page or contact support.
                    </div>
                `;
				if (domElements.loading) domElements.loading.classList.add('hidden');
				return;
			}

			// 3. Initialize Firebase
			const firebaseConfig = {
				apiKey: "AIzaSyAWcNOwrXfC5jAjqx1oqI60KAvFzctN80M",
				authDomain: "portfolio-621a6.firebaseapp.com",
				projectId: "portfolio-621a6",
				storageBucket: "portfolio-621a6.firebasestorage.app",
				messagingSenderId: "512000689939",
				appId: "1:512000689939:web:29a9c141131df847ccfce6",
				measurementId: "G-8VZM1DYD1L"
			};

			try {
				// Initialize Firebase if not already initialized
				if (!firebase.apps.length) {
					firebase.initializeApp(firebaseConfig);
				}
				const db = firebase.firestore();

				// 4. Load and display data
				loadData(db, domElements);
			} catch (error) {
				console.error("Firebase initialization failed:", error);
				showError(domElements, `Database connection failed: ${error.message}`);
			}
		});

		// Function to load and display data
		async function loadData(db, { loading, error, tableContainer, tableBody }) {
			try {
				// Show loading state
				loading.classList.remove('hidden');
				error.classList.add('hidden');
				tableContainer.classList.add('hidden');

				// Get data from Firestore
				const snapshot = await db.collection("contacts")
					.orderBy("timestamp", "desc")
					.get();

				// Process the data
				if (snapshot.empty) {
					tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center">No submissions found</td></tr>';
				} else {
					tableBody.innerHTML = '';
					snapshot.forEach(doc => {
						const data = doc.data();
						const row = document.createElement('tr');
						row.innerHTML = `
					        <td><h4>${escapeHtml(data.name) || '-'}</h4></td>
                            <td> <h5>${escapeHtml(data.email) || '-'}</h5></td>
                            <td><h5>${escapeHtml(data.message) || '-'}</h5></td>
                            <td>${formatDate(data.timestamp)}</td>
                        `;
						tableBody.appendChild(row);
					});
				}

				// Show the data
				loading.classList.add('hidden');
				tableContainer.classList.remove('hidden');

			} catch (error) {
				console.error("Error loading data:", error);
				showError({ loading, error }, `Failed to load data: ${error.message}`);
			}
		}

		// Helper function to show errors
		function showError({ loading, error }, message) {
			if (loading) loading.classList.add('hidden');
			if (error) {
				error.textContent = message;
				error.classList.remove('hidden');
			} else {
				document.body.innerHTML += `<div class="error-message">${message}</div>`;
			}
		}

		// Helper function to format dates
		function formatDate(timestamp) {
			if (!timestamp) return 'N/A';
			try {
				return timestamp.toDate().toLocaleString();
			} catch (error) {
				console.error("Date formatting error:", error);
				return 'Invalid Date';
			}
		}

		// Helper function to prevent XSS
		function escapeHtml(unsafe) {
			if (!unsafe) return '';
			return unsafe.toString()
				.replace(/&/g, "&amp;")
				.replace(/</g, "&lt;")
				.replace(/>/g, "&gt;")
				.replace(/"/g, "&quot;")
				.replace(/'/g, "&#039;");
		}
	</script>

	<!-- Scripts -->
	<script src="assets/js/jquery.min.js"></script>
	<script src="assets/js/jquery.scrolly.min.js"></script>
	<script src="assets/js/browser.min.js"></script>
	<script src="assets/js/breakpoints.min.js"></script>
	<script src="assets/js/util.js"></script>
	<script src="assets/js/main.js"></script>
</body>

</html>